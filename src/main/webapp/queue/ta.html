<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Queue</title>
    <!-- Firebase App (the core Firebase SDK) must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.15.1/firebase-app.js"></script>
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/7.15.1/firebase-auth.js"></script>

    <link rel="stylesheet" href="taQueue.css">
    <link rel="stylesheet" href="/style/common.css">
    <!--Font-->
    <link href='https://fonts.googleapis.com/css?family=Noto+Sans:400,700,400italic,700italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'></link>
  </head>

  <script>
    var repeat = setInterval(getQueue, 1000);
    var taToken;

    function getToken() {
      var firebaseConfig = {
        apiKey: "AIzaSyA1r_PfVDCXfTgoUNisci5Ag2MKEEwsZCE",
        authDomain: "fulfillment-deco-step-2020.firebaseapp.com",
        databaseURL: "https://fulfillment-deco-step-2020.firebaseio.com",
        projectId: "fulfillment-deco-step-2020",
        storageBucket: "fulfillment-deco-step-2020.appspot.com",
        messagingSenderId: "7165833112",
        appId: "1:7165833112:web:3b4af53c5de6aa73b7c5ed"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);

      var user = firebase.auth().currentUser;
      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          console.log("User is signed in");
          user.getIdToken().then((token) => setToken(token));
        } 
        // Redirect to home page if not logged in
        else {
          console.log("User is not logged in");
          window.location.href = "/";
        }
      });
    }

    function setToken(token){
      taToken = token;
      getQueue();
    }

    function getQueue() {
      var params = window.location.search;
      const request = new Request("/get-queue" + params + "&idToken=" + taToken, {method: "GET"});

      fetch(request).then(response => response.json()).then((queue) => {
        const queueListElement = document.getElementById('queue');
        queueListElement.innerText = "";
        queue.queue.forEach((studentEmail) => {
          queueListElement.appendChild(createListElement(studentEmail));
        });

        if (queue.helping) {
          const beinghelpedEle = document.getElementById('beingHelped');
          beinghelpedEle.innerHTML = "";
          document.getElementById('beingHelped').appendChild(createHelpedElem(queue.helping.email, queue.helping.workspace));
        }else {
          const beinghelpedEle = document.getElementById('beingHelped');
          beinghelpedEle.innerHTML = "";
        }
      });
    }

    function notifyStudent(studentEmail){
      var params = window.location.search + "&studentEmail=" + studentEmail + "&taToken=" + taToken;
      const request = new Request("/notify-student" + params, {method: "POST"});
      
      fetch(request).then(getQueue);

      getQueue();
    }


    function endHelp(studentEmail){
      var params = window.location.search + "&studentEmail=" + studentEmail + "&taToken=" + taToken;
      const request = new Request("/end-help" + params, {method: "POST"});
      
      fetch(request).then(() => {
        document.getElementById('beingHelped').innerText = "";
        getQueue()
        });

      
    }

    function createListElement(studentEmail) {
      let notifyElem = document.createElement("div");
      notifyElem.className = "student-container";

      let student = document.createElement('p');
      student.innerText = studentEmail;
      student.className = "student-info";

      let btn = document.createElement("input");
      btn.value = "notify student you're ready to help";
      btn.type = "button";
      btn.id = studentEmail;
      btn.className = "notify-button";
      btn.onclick = function(){notifyStudent(this.id);};

      notifyElem.appendChild(student);
      notifyElem.appendChild(btn);

      return notifyElem;
    }

    function createHelpedElem(studentEmail, url){
      let studentElem = document.createElement("div");
      studentElem.className = "help-container";

      let student = document.createElement('p');
      student.innerText = "You are helping " + studentEmail;
      student.className = "help-info";

      let btn = document.createElement("input");
      btn.value = "end interaction";
      btn.type = "button";
      btn.id = studentEmail;
      btn.className = "end-button";
      btn.onclick = function(){endHelp(this.id);};

      studentElem.appendChild(student);
      studentElem.appendChild(btn);
      studentElem.appendChild(createLink(url));

      return studentElem;
    }

    function createLink(url){
      let link = document.createElement("a");
      link.id = "workspaceRedirect";
      link.rel= "noopener noreferrer";
      link.target= "_blank";
      link.href = url;
      link.style = "text-decoration: none;"
      link.innerText = "Go to Workspace";

      return link;
    }
  </script>

  <body onload="getToken()">
    <div class="top-right-buttons">
      <button class="reg-button" onclick="signOut()">Log Out</button>
    </div>
    <div id = "beingHelped" class="wrapper"> </div>
    
    <h1 id="queue-start">waitlist: pull from top first!</h1>
    <div id="queue" class="wrapper"></div>
  </body>
</html>