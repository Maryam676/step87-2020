<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>User Dashboard</title>

    <!-- Firebase App (the core Firebase SDK) must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.15.1/firebase-app.js"></script>
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/7.15.1/firebase-auth.js"></script>
    
    <script src="/script/auth.js"></script>
    <link rel="stylesheet" href="userDash.css">
    <link rel="stylesheet" href="/style/common.css">
    <!--Font-->
    <link href='https://fonts.googleapis.com/css?family=Noto+Sans:400,700,400italic,700italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'></link>
  </head>

  <script>
    let userToken;
    
    let registeredClasses;
    let ownedClasses;
    let taClasses;

    let firebaseConfig = {
      apiKey: "AIzaSyA1r_PfVDCXfTgoUNisci5Ag2MKEEwsZCE",
      authDomain: "fulfillment-deco-step-2020.firebaseapp.com",
      databaseURL: "https://fulfillment-deco-step-2020.firebaseio.com",
      projectId: "fulfillment-deco-step-2020",
      storageBucket: "fulfillment-deco-step-2020.appspot.com",
      messagingSenderId: "7165833112",
      appId: "1:7165833112:web:3b4af53c5de6aa73b7c5ed"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    function init() {
      var user = firebase.auth().currentUser;
      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          user.getIdToken().then((token) => {
            userToken = token;
            document.getElementById("idToken").value = token;

            getClasses();
          });
        } 
        // Redirect to home page if not logged in
        else {
          console.log("User is not logged in");
          window.location.href = "/";
        }
      });
    }

    function getClasses(){
      var params ="?idToken=" + userToken;
      const request = new Request("/get-user" + params, {method: "GET"});

      fetch(request).then(response => response.json()).then(userData => {
        userData.forEach(element => {
          if (element.type === "taClasses") {
            document.getElementById("taHeader").classList.remove("hidden");
          }
          var sectionElement = document.getElementById(element.type);
          sectionElement.prepend(createClassElement(element.code, element.name, element.type, element.inQueue));
        });
      });
    }

    function createClassElement(classCode, nameClass, type, inQueue) {
      var params;
      var urlRedirect;
      if (type !== "registeredClasses"){
        params = "?classCode="+classCode+"&idToken="+userToken+ "&enterTA=" + "isTA";
        urlRedirect = "/queue/ta.html?classCode=" + classCode;
      } else {
        params = "?classCode="+classCode+"&idToken="+userToken;
        urlRedirect = "/queue/student.html?classCode=" + classCode;
      }

      let enterElem = document.createElement("div");
      enterElem.className = "class-container";
      enterElem.onclick = function(){enterQueue(params, urlRedirect, type);};

      let center = document.createElement("div");
      center.className = "class-info-container";
      let classElem;
      if (inQueue) {
        classElem = document.createElement('div');
        classElem.className = "class-info";

        let classP = document.createElement('p');
        classP.innerHTML = nameClass;

        let inQueueIndicator = document.createElement("p");
        inQueueIndicator.innerText = "In Queue!"
        inQueueIndicator.className = "in-queue-indicator"

        classElem.appendChild(classP);
        classElem.appendChild(inQueueIndicator);
      } else {
        classElem = document.createElement('p');
        classElem.innerText = nameClass;
        classElem.className = "class-info";
      }

      center.appendChild(classElem);
      enterElem.appendChild(center);

      return enterElem;
    }

    function enterQueue(params, urlRedirect, type){
      if (type === "registeredClasses"){
        const request = new Request("/enterqueue" + params, {method: "POST"});
        fetch(request).then(response => {
          window.location.assign(urlRedirect);
        }).catch(function(err) {
            console.info(err);
        });
      } else {
        window.location.assign(urlRedirect);
      }
      
    }

    function requestAccess() {
      const classCodeInput = document.getElementById("classCode");
      fetch(`/requestAccess?idToken=${userToken}&classCode=${classCodeInput.value}`).then(resp => {
        classCodeInput.value = "";
        window.location.href = "#";
      });
    }
    
  </script>

  <body onload="init()">
    <div class = "wrapper">
        <div class="top-right-buttons">
          <button class="reg-button" onclick="signOut()">Log Out</button>
        </div>

        <h1 class="section-name">Classes you are registered in:</h1>
        <div id="registeredClasses">
          <a class="class-container" href="#register-popup">
            <div class="class-info-container">
              <p class="class-info">Request access!</p>
            </div>
          </a>
        </div>

        <h1 class="section-name hidden" id="taHeader">Classes you are on teaching staff:</h1>
        <div id="taClasses"></div>

        <h1 class="section-name">Classes you own:</h1>
        <div id="ownedClasses">
          <a href="#popup-container" class="class-container">
            <div class="class-info-container">
              <div class="class-info">
                <p style="margin: 5px;">Create new class!</p>
                <p class="plus">+</p>
              </div>
            </div>
          </a>
        </div>

        <div id="register-popup" class="overlay">
          <div class="popup">
              <a class="close" href="#">&times;</a>
              <div>
                  <input type="text" id="classCode" placeholder="Class Code"/>
                  <button class="button" onclick="requestAccess()">Request Access</button>
                </form>
              </div>
          </div>
        </div>
      </div>
      <div id="popup-container" class="overlay">
          <div class="popup">
              <a class="close" href="#">&times;</a>
              <div id="createClass" class="wrapper">
                <form action="/newclass" method="POST">
                  <input type="text" name="className" placeholder="Enter class name:"></input>
                  <input type="hidden" name="idToken" id="idToken" value=""/>
                  <input class="button" type="submit" value="create"/>
                </form>
              </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>