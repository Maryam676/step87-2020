<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Queue</title>

    <!-- Firebase App (the core Firebase SDK) must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.15.1/firebase-app.js"></script>
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/7.15.1/firebase-auth.js"></script>
    
    <script src="/script/auth.js"></script>
    <link rel="stylesheet" href="userDash.css">

    <!--Font-->
    <link href='https://fonts.googleapis.com/css?family=Noto+Sans:400,700,400italic,700italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'></link>
  </head>

  <script>
    let userToken;
    
    let registeredClasses;
    let ownedClasses;
    let taClasses;

    let firebaseConfig = {
      apiKey: "AIzaSyA1r_PfVDCXfTgoUNisci5Ag2MKEEwsZCE",
      authDomain: "fulfillment-deco-step-2020.firebaseapp.com",
      databaseURL: "https://fulfillment-deco-step-2020.firebaseio.com",
      projectId: "fulfillment-deco-step-2020",
      storageBucket: "fulfillment-deco-step-2020.appspot.com",
      messagingSenderId: "7165833112",
      appId: "1:7165833112:web:3b4af53c5de6aa73b7c5ed"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    function init() {
      var user = firebase.auth().currentUser;
      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          console.log("User is signed in");
          user.getIdToken().then((token) => {
            userToken = token;
            document.getElementById("idToken").value = token;

            getClasses();
          });
        } 
        // Redirect to home page if not logged in
        else {
          console.log("User is not logged in");
          window.location.href = "/";
        }
      });
    }

    function getClasses(){
      var params ="?idToken=" + userToken;
      const request = new Request("/get-user" + params, {method: "GET"});

      fetch(request).then(response => response.json()).then(userData => {
        userData.forEach(element => {
          var sectionElement = document.getElementById(element.type);
          sectionElement.appendChild(createClassElement(element.code, element.name, element.type));
        });
      });
    }

    function createClassElement(classCode, nameClass, type) {
      var params;
      var urlRedirect;
      if (type != "registeredClasses"){
        params = "?classCode="+classCode+"&idToken="+userToken+ "&enterTA=" + "isTA";
        urlRedirect = "/queue/ta.html?classCode=" + classCode;
      } else {
        params = "?classCode="+classCode+"&idToken="+userToken;
        urlRedirect = "/queue/student.html?classCode=" + classCode;
      }

      let enterElem = document.createElement("div");
      enterElem.className = "class-container";
      enterElem.onclick = function(){enterQueue(params, urlRedirect);};

      let enter = document.createElement('p');
      enter.innerText = "enter";

      let classElem = document.createElement('p');
      classElem.innerText = nameClass;
      classElem.className = "class-info";

      enterElem.appendChild(enter);
      enterElem.appendChild(classElem);

      return enterElem;
    }

    function enterQueue(params, urlRedirect){
      const request = new Request("/enterqueue" + params, {method: "POST"});
      fetch(request).then(response => {
        window.location.assign(urlRedirect);
      })
      .catch(function(err) {
        console.info(err);
      });
    }

    function requestAccess() {
      const classCodeInput = document.getElementById("classCode");
      fetch(`/requestAccess?idToken=${userToken}&classCode=${classCodeInput.value}`).then(resp => {
        classCodeInput.value = "";
        window.location.href = "#";
      });
    }
    
  </script>

  <body onload="init()">
    <div class = "wrapper">
        <h1 class = "section-name">Classes you are registered in:</h1>
        <div id = "registeredClasses"> </div>
        <a class="button" href="#register-popup">Request access!</a>

        <h1 class = "section-name">Classes you are on teaching staff:</h1>
        <div id = "taClasses"></div>

        <h1 class = "section-name">Classes you own:</h1>
        <div id = "ownedClasses"></div>

        <a class="button" href="#popup-container">Create new class!</a>

        <div id="register-popup" class="overlay">
          <div class="popup">
              <a class="close" href="#">&times;</a>
              <div>
                  <input type="text" id="classCode" placeholder="Class Code"/>
                  <br />
                  <button onclick="requestAccess()">Request Access</button>
                </form>
              </div>
          </div>
      </div>

        <div id="popup-container" class="overlay">
            <div class="popup">
                <a class="close" href="#">&times;</a>
                <div id = "createClass">
                  <form action="/newclass" method="POST">
                    <textarea name="className" placeholder="Enter class name:"></textarea>
                    <br>
                    <input type="hidden" name="idToken" id="idToken" value=""/>
                    <input type="submit" value="create"/>
                  </form>
                </div>
            </div>
        </div>
        
    </div>
  </body>
</html>